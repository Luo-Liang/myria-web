{% extends "demobase.html" %}

<!--{% block queries_active %} class="active"{% endblock %}-->

{% block extra_head %}
<link rel="stylesheet" type="text/css" href="css/queryvis.css">
<link rel="stylesheet" type="text/css" href="css/istcdemo.css">
{% endblock %}

{% block extra_container_class %}my-fluid-container{% endblock %}

{% block content %}

{% endblock %}
{% block extra_body %}
<div style="margin:4px; padding:4px">
<table>
    <h2>Screen 3: Genomic Data Processing</h2>
    <tr>
        <h4>MetaData Visualizer:</h4>
        <td>
            <div style="margin:4px; padding:4px">
                <p>x-axis: <select id="x_select" onchange="update()"> </select></p>
            </div>
        </td>
        <td>
            <div style="margin:4px; padding:4px">
                <p>x-axis: <select id="x_select2" onchange="update2()"> </select></p>
            </div>
        </td>
    </tr>
    <tr>
        <td>
            <div style="margin:4px; padding:4px">
                <p>y-axis: <select id="y_select" onchange="update()"> </select></p>
            </div>
        </td>
        <td>
            <div style="margin:4px; padding:4px">
                <p>y-axis: <select id="y_select2" onchange="update2()"> </select></p>
            </div>
        </td>
    </tr>
    <tr>
        <td>
            <div style="margin:4px; padding:4px">
                <div id="plot"></div>
            </div>
        </td>
        <td>
            <div style="margin:4px; padding:4px">
                <div id="plot2"></div>
            </div>
        </td>
    </tr>
</table>
</div>

<div id="bcdiv" style="margin:4px; padding:4px">
    <h4>Dissimilarity between samples: </h4>
    <table>
        <tr>Add a filter: <input id="filter_text" type="text" value="row['depth']<50"></tr> <button id="filter" onclick="filter()">Update</button>
    <tr>
        <td><div id="diversity"></div></td>
        <td>Choose another variable: <select id="var_select" onchange="update_hist()"> </select> <button id="sort_fields" onclick="sort_everything()">Sort</button>
            <div id="plot_hist"></div>
        </td>
    </tr>
    </table>
</div>


{% endblock %}
{% block footer %}
<script src="js/d3.min.js" type="text/javascript" charset="utf-8"></script>
<script src="js/colorbrewer.js" type="text/javascript" charset="utf-8"></script>
<script src="js/d3.selection.popover.js" type="text/javascript" charset="utf-8"></script>
<script src="js/d3.selection.tooltip.js" type="text/javascript" charset="utf-8"></script>
<script src="js/chroma.min.js" type="text/javascript" charset="utf-8"></script>
<script src="js/graph.js" type="text/javascript" charset="utf-8"></script>
<script src="js/networkvis.js" type="text/javascript" charset="utf-8"></script>
<script src="js/fragmentvis.js" type="text/javascript" charset="utf-8"></script>
<script src="js/fragmentoverview.js" type="text/javascript" charset="utf-8"></script>
<script src="js/operatorvis.js" type="text/javascript" charset="utf-8"></script>
<script src="js/querystats.js" type="text/javascript" charset="utf-8"></script>
<script src="js/colorlegend.js" type="text/javascript" charset="utf-8"></script>
<script src="js/viz.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="js/queryvis.js" charset="utf-8"></script>
<script>
function plot(data, xattr, yattr, divname) {
    var vlSpec = {
        "data": {
            "values": data
        },
        "mark": "circle",
        "encoding": {
            "x": {
                "field": xattr,
                "type": "quantitative"
            },
            "y": {
                "field": yattr,
                "type": "quantitative"
            }
        }
    };

    var embedSpec = {
        mode: "vega-lite",
        spec: vlSpec
    };

    vg.embed(divname, embedSpec, function(error, result) {});
};

function plot_hist(data, sort_map, yattr) {
    document.getElementById('var_select').value = yattr;
    for(var i = 0; i< data.length; i++){
        data[i]["sortindex"] = sort_map[data[i]["Library"]];
    }

    function applyfilter(row){
        var filter_text = document.getElementById('filter_text').value;
        if (filter_text == '')
            return 1==1;
        else
            return eval(filter_text);
    }

    data = data.filter(applyfilter);

    var vlSpec = {
        "data": {
            "values": data
        },
        "mark": "bar",
        "encoding": {
            "y": {
                "field": "Library",
                "type": "ordinal",
                "axis": false,
                "sort": {"op":"mean", "field": "sortindex"}
            },
            "x": {
                "field": yattr,
                "type": "quantitative",
                "axis": {
                    "orient":"top",
                    "offset":18
                }
            }
        },
        "config": {
        "scale": {
            "textBandWidth": 15,
            "bandSize": 15
        }
    }
    };

    var embedSpec = {
        mode: "vega-lite",
        spec: vlSpec
    };

    vg.embed("#plot_hist", embedSpec, function(error, result) {});
};

function plot_bc(data, bc_full, sort_map, filter){
    for(var i = 0; i< bc_full.length; i++){
        sampa = bc_full[i]["asample"];
        sampb = bc_full[i]["bsample"];
        if(sampa.length>5)
            sampa = sampa.substring(1,6);
        if(sampb.length>5)
            sampb = sampb.substring(1,6);
        bc_full[i]["asample"] = sampa;
        bc_full[i]["bsample"] = sampb;

        bc_full[i]["sortindexa"] = sort_map[bc_full[i]["asample"]];
        bc_full[i]["sortindexb"] = sort_map[bc_full[i]["bsample"]];
    }

    function applyfilter(row){
        var filter_text = document.getElementById('filter_text').value;
        if (filter_text == '')
            return 1==1;
        else
            return eval(filter_text);
    }

    data = data.filter(applyfilter);
    filtered_samples = [];
    for(d in data)
        filtered_samples.push(data[d]['Library']);
    bc_filtered = [];
    console.log(filtered_samples);
    for(d in bc_full)
        if (filtered_samples.indexOf(bc_full[d]['asample']) != -1 && filtered_samples.indexOf(bc_full[d]['bsample']) !=-1)
            bc_filtered.push(bc_full[d]);

    var vlSpec_bc = {
        "data": {
            "values": bc_filtered
        },
        "mark": "text",
        "encoding": {
            "row": {
                "field": "asample",
                "type": "nominal",
                "axis": {
                    "orient":"right",
                    "title":"Sample"
                },
                "sort": {"op":"mean", "field": "sortindexa"}
            },
            "column": {
                "field": "bsample",
                "type": "nominal",
                "axis": {
                    "labelAngle": -90,
                    "offset": 20,
                    "title": "Sample"
                },
                "sort": {"op":"mean", "field": "sortindexb"}
            },
            "color": {
                "field": "BCdis",
                "type": "quantitative",
                "legend":false
            },
            "text": {
                "field": "none",
                "type": "nominal"
            }
        },
        "config": {
            "mark": {
                "applyColorToBackground": true
            },
            "scale": {
                "textBandWidth": 15,
                "bandSize": 15
            }
        }
    };
    var embedSpec_bc = {
        mode: "vega-lite",
        spec: vlSpec_bc
    };

    vg.embed("#diversity", embedSpec_bc, function(error, result) {});
}

function _update(x,y,d) {
    plot({{ data | safe }}, document.getElementById(x).value, document.getElementById(y).value, d);
}

function update(){
    _update('x_select','y_select','#plot');
}

function update2(){
    _update('x_select2','y_select2','#plot2');
}

function update_hist(){
    if (default_sorting == false)
        plot_bc(data, bc_full, sort_map);
        default_sorting = true;
    plot_hist(data, sort_map, document.getElementById('var_select').value);
}

function sort_everything(){
    var data = {{ data | safe }};
    var bc_full = {{ bc_full | safe }};
    //bc_full = bc_full.concat({
    //    "asample": "S0158",
    //    "bsample": "S0158",
    //    "BCdis": 0.0
    //});
    var sort_field = document.getElementById('var_select').value;
    var sorted_data = [];
    for(var i=0; i<data.length; i++){
        sorted_data.push({"sample":data[i]["Library"], "sort_field": data[i][sort_field]});
    }

    function compare(a,b) {
        if (a['sort_field'] < b['sort_field'])
            return -1;
        if (a['sort_field'] > b['sort_field'])
            return 1;
        return 0;
    }
    sorted_data.sort(compare);

    var sort_map = {};
    for(var i=0; i<sorted_data.length; i++)
        sort_map[sorted_data[i]["sample"]] = i+1;
    console.log(sort_map);
    plot_bc(data, bc_full, sort_map);
    plot_hist(data, sort_map, sort_field);
    default_sorting = false;
}

function filter(){
    var data = {{ data | safe }};
    var bc_full = {{ bc_full | safe }};
    //bc_full = bc_full.concat({
    //    "asample": "S0158",
    //    "bsample": "S0158",
    //    "BCdis": 0.0
    //});
    var sort_map = {"S0370":1,"S0302":1,"S0065":1,"S0096":1,"S0087":1,"S0127":1,"S0106":1,"S0295":1,"S0368":1,"S0355":1,"S0211":1,"S0285":1,"S0200":1,"S0129":1,"S0271":1,"S0145":1,"S0191":1,"S0277":1,"S0411":1,"S0201":1,"S0297":1,"S0185":1,"S0091":1,"S0241":1,"S0111":1,"S0055":1,"S0008":1,"S0371":1,"S0175":1,"S0001":1,"S0436":1,"S0274":1,"S0119":1,"S0039":1,"S0386":1,"S0308":1,"S0149":1,"S0028":1,"S0389":1,"S0190":1,"S0143":1,"S0226":1,"S0254":1,"S0142":1,"S0077":1,"S0062":1,"S0381":1,"S0306":1,"S0243":1,"S0237":1,"S0216":1,"S0205":1,"S0372":1,"S0361":1,"S0157":1,"S0105":1,"S0003":1,"S0325":1,"S0272":1,"S0251":1,"S0025":1,"S0021":1,"S0432":1,"S0217":1,"S0098":1,"S0430":1,"S0094":1,"S0363":1,"S0227":1,"S0100":1,"S0394":1,"S0184":1,"S0319":1,"S0357":1,"S0207":1,"S0072":1,"S0220":1,"S0112":1,"S0013":1,"S0419":1,"S0352":1,"S0291":1,"S0322":1,"S0281":1,"S0438":1,"S0289":1,"S0011":1,"S0195":1,"S0424":1,"S0353":1,"S0089":1,"S0060":1,"S0057":1,"S0280":1,"S0374":1,"S0029":1,"S0202":1,"S0228":1,"S0334":1,"S0324":1,"S0373":1,"S0301":1,"S0158":1,"S0164":1,"S0120":1,"S0104":1,"S0333":1,"S0006":1,"S0328":1,"S0315":1,"S0178":1,"S0247":1,"S0225":1,"S0376":1,"S0317":1,"S0085":1,"S0075":1,"S0051":1,"S0428":1,"S0080":1,"S0070":1,"S0048":1,"S0431":1,"S0222":1,"S0214":1,"S0079":1,"S0086":1,"S0385":1,"S0367":1,"S0179":1,"S0040":1,"S0004":1,"S0167":1,"S0224":1,"S0126":1,"S0347":1,"S0144":1,"S0114":1,"S0083":1,"S0052":1,"S0097":1,"S0090":1,"S0118":1,"S0110":1,"S0012":1,"S0050":1,"S0244":1,"S0131":1,"S0009":1,"S0349":1,"S0298":1,"S0388":1,"S0305":1,"S0362":1,"S0318":1,"S0268":1,"S0264":1,"S0088":1,"S0076":1,"S0391":1,"S0341":1,"S0155":1,"S0257":1,"S0133":1,"S0132":1,"S0402":1,"S0379":1,"S0261":1,"S0136":1,"S0042":1,"S0030":1,"S0377":1,"S0360":1,"S0350":1,"S0313":1,"S0173":1,"S0270":1,"S0246":1,"S0279":1,"S0045":1,"S0002":1,"S0429":1,"S0396":1,"S0192":1,"S0286":1,"S0204":1,"S0332":1,"S0108":1,"S0101":1,"S0263":1,"S0262":1,"S0128":1,"S0345":1,"S0138":1,"S0219":1,"S0425":1,"S0401":1,"S0238":1,"S0081":1,"S0064":1,"S0445":1,"S0218":1,"S0022":1,"S0188":1,"S0329":1,"S0092":1,"S0117":1,"S0235":1,"S0435":1,"S0232":1,"S0206":1,"S0084":1,"S0311":1,"S0303":1,"S0078":1,"S0151":1,"S0033":1,"S0416":1,"S0115":1,"S0020":1,"S0156":1,"S0193":1,"S0356":1,"S0282":1,"S0398":1,"S0378":1,"S0215":1,"S0212":1,"S0292":1,"S0252":1,"S0187":1,"S0258":1,"S0140":1,"S0017":1,"S0284":1,"S0166":1,"S0154":1,"S0177":1,"S0267":1,"S0255":1,"S0099":1,"S0197":1,"S0181":1,"S0161":1,"S0049":1,"S0437":1,"S0198":1,"S0405":1,"S0182":1,"S0141":1,"S0074":1,"S0351":1,"S0174":1,"S0203":1,"S0165":1,"S0209":1,"S0423":1,"S0415":1,"S0186":1,"S0233":1,"S0134":1,"S0314":1,"S0312":1,"S0273":1,"S0047":1,"S0168":1,"S0159":1,"S0269":1,"S0249":1,"S0239":1,"S0123":1,"S0107":1,"S0299":1,"S0344":1,"S0027":1,"S0404":1,"S0307":1,"S0061":1,"S0316":1,"S0139":1,"S0037":1,"S0196":1,"S0275":1,"S0253":1,"S0005":1,"S0406":1,"S0223":1,"S0410":1,"S0387":1,"S0053":1,"S0326":1,"S0102":1,"S0069":1,"S0366":1,"S0293":1,"S0183":1,"S0137":1,"S0035":1,"S0290":1,"S0010":1,"S0199":1,"S0095":1,"S0248":1,"S0245":1,"S0019":1,"S0018":1,"S0342":1,"S0171":1,"S0032":1,"S0337":1,"S0234":1,"S0397":1,"S0296":1,"S0294":1,"S0189":1,"S0240":1,"S0231":1,"S0073":1,"S0236":1,"S0409":1,"S0336":1,"S0071":1,"S0066":1,"S0016":1,"S0393":1,"S0278":1,"S0260":1,"S0026":1,"S0150":1,"S0054":1,"S0390":1,"S0256":1,"S0130":1,"S0093":1,"S0169":1,"S0034":1,"S0340":1,"S0058":1,"S0046":1,"S0331":1,"S0321":1,"S0180":1,"S0384":1,"S0375":1,"S0242":1,"S0109":1,"S0043":1,"S0422":1,"S0382":1,"S0323":1,"S0304":1,"S0135":1,"S0068":1,"S0063":1,"S0354":1,"S0116":1,"S0383":1,"S0276":1,"S0229":1,"S0124":1,"S0059":1,"S0407":1,"S0380":1,"S0015":1,"S0343":1,"S0283":1,"S0250":1,"S0125":1,"S0392":1,"S0265":1,"S0082":1,"S0036":1,"S0024":1,"S0395":1,"S0369":1,"S0335":1,"S0266":1,"S0122":1,"S0023":1,"S0403":1,"S0300":1,"S0172":1,"S0153":1,"S0221":1,"S0443":1,"S0358":1,"S0348":1,"S0103":1,"S0067":1,"S0365":1,"S0213":1,"S0031":1,"S0359":1,"S0309":1,"S0259":1,"S0041":1};

    default_sorting = true;
    plot_hist(data, sort_map, document.getElementById('var_select').value);
    plot_bc(data, bc_full, sort_map);
}

// Initialization
var data = {{ data | safe }};
var select_dds = ["x_select", "y_select", "var_select", "x_select2", "y_select2"];

for (dd in select_dds) {
    var s = document.getElementById(select_dds[dd]);
    keys = Object.keys(data[0]);
    for (k in keys) {
        var o = document.createElement("option");
        o.value = keys[k];
        o.text = keys[k];
        s.appendChild(o);
    }
}

var default_sorting = true;

var bc_full = {{ bc_full | safe }};
//bc_full = bc_full.concat({
//    "asample": "S0158",
//    "bsample": "S0158",
//   "BCdis": 0.0
//});

document.getElementById('x_select').value = "depth";
document.getElementById('y_select').value = "simp";
plot(data, "depth", "simp", "#plot");

document.getElementById('x_select2').value = "depth";
document.getElementById('y_select2').value = "entropy";
plot(data, "depth", "entropy", "#plot2");
var sort_map = {"S0370":1,"S0302":1,"S0065":1,"S0096":1,"S0087":1,"S0127":1,"S0106":1,"S0295":1,"S0368":1,"S0355":1,"S0211":1,"S0285":1,"S0200":1,"S0129":1,"S0271":1,"S0145":1,"S0191":1,"S0277":1,"S0411":1,"S0201":1,"S0297":1,"S0185":1,"S0091":1,"S0241":1,"S0111":1,"S0055":1,"S0008":1,"S0371":1,"S0175":1,"S0001":1,"S0436":1,"S0274":1,"S0119":1,"S0039":1,"S0386":1,"S0308":1,"S0149":1,"S0028":1,"S0389":1,"S0190":1,"S0143":1,"S0226":1,"S0254":1,"S0142":1,"S0077":1,"S0062":1,"S0381":1,"S0306":1,"S0243":1,"S0237":1,"S0216":1,"S0205":1,"S0372":1,"S0361":1,"S0157":1,"S0105":1,"S0003":1,"S0325":1,"S0272":1,"S0251":1,"S0025":1,"S0021":1,"S0432":1,"S0217":1,"S0098":1,"S0430":1,"S0094":1,"S0363":1,"S0227":1,"S0100":1,"S0394":1,"S0184":1,"S0319":1,"S0357":1,"S0207":1,"S0072":1,"S0220":1,"S0112":1,"S0013":1,"S0419":1,"S0352":1,"S0291":1,"S0322":1,"S0281":1,"S0438":1,"S0289":1,"S0011":1,"S0195":1,"S0424":1,"S0353":1,"S0089":1,"S0060":1,"S0057":1,"S0280":1,"S0374":1,"S0029":1,"S0202":1,"S0228":1,"S0334":1,"S0324":1,"S0373":1,"S0301":1,"S0158":1,"S0164":1,"S0120":1,"S0104":1,"S0333":1,"S0006":1,"S0328":1,"S0315":1,"S0178":1,"S0247":1,"S0225":1,"S0376":1,"S0317":1,"S0085":1,"S0075":1,"S0051":1,"S0428":1,"S0080":1,"S0070":1,"S0048":1,"S0431":1,"S0222":1,"S0214":1,"S0079":1,"S0086":1,"S0385":1,"S0367":1,"S0179":1,"S0040":1,"S0004":1,"S0167":1,"S0224":1,"S0126":1,"S0347":1,"S0144":1,"S0114":1,"S0083":1,"S0052":1,"S0097":1,"S0090":1,"S0118":1,"S0110":1,"S0012":1,"S0050":1,"S0244":1,"S0131":1,"S0009":1,"S0349":1,"S0298":1,"S0388":1,"S0305":1,"S0362":1,"S0318":1,"S0268":1,"S0264":1,"S0088":1,"S0076":1,"S0391":1,"S0341":1,"S0155":1,"S0257":1,"S0133":1,"S0132":1,"S0402":1,"S0379":1,"S0261":1,"S0136":1,"S0042":1,"S0030":1,"S0377":1,"S0360":1,"S0350":1,"S0313":1,"S0173":1,"S0270":1,"S0246":1,"S0279":1,"S0045":1,"S0002":1,"S0429":1,"S0396":1,"S0192":1,"S0286":1,"S0204":1,"S0332":1,"S0108":1,"S0101":1,"S0263":1,"S0262":1,"S0128":1,"S0345":1,"S0138":1,"S0219":1,"S0425":1,"S0401":1,"S0238":1,"S0081":1,"S0064":1,"S0445":1,"S0218":1,"S0022":1,"S0188":1,"S0329":1,"S0092":1,"S0117":1,"S0235":1,"S0435":1,"S0232":1,"S0206":1,"S0084":1,"S0311":1,"S0303":1,"S0078":1,"S0151":1,"S0033":1,"S0416":1,"S0115":1,"S0020":1,"S0156":1,"S0193":1,"S0356":1,"S0282":1,"S0398":1,"S0378":1,"S0215":1,"S0212":1,"S0292":1,"S0252":1,"S0187":1,"S0258":1,"S0140":1,"S0017":1,"S0284":1,"S0166":1,"S0154":1,"S0177":1,"S0267":1,"S0255":1,"S0099":1,"S0197":1,"S0181":1,"S0161":1,"S0049":1,"S0437":1,"S0198":1,"S0405":1,"S0182":1,"S0141":1,"S0074":1,"S0351":1,"S0174":1,"S0203":1,"S0165":1,"S0209":1,"S0423":1,"S0415":1,"S0186":1,"S0233":1,"S0134":1,"S0314":1,"S0312":1,"S0273":1,"S0047":1,"S0168":1,"S0159":1,"S0269":1,"S0249":1,"S0239":1,"S0123":1,"S0107":1,"S0299":1,"S0344":1,"S0027":1,"S0404":1,"S0307":1,"S0061":1,"S0316":1,"S0139":1,"S0037":1,"S0196":1,"S0275":1,"S0253":1,"S0005":1,"S0406":1,"S0223":1,"S0410":1,"S0387":1,"S0053":1,"S0326":1,"S0102":1,"S0069":1,"S0366":1,"S0293":1,"S0183":1,"S0137":1,"S0035":1,"S0290":1,"S0010":1,"S0199":1,"S0095":1,"S0248":1,"S0245":1,"S0019":1,"S0018":1,"S0342":1,"S0171":1,"S0032":1,"S0337":1,"S0234":1,"S0397":1,"S0296":1,"S0294":1,"S0189":1,"S0240":1,"S0231":1,"S0073":1,"S0236":1,"S0409":1,"S0336":1,"S0071":1,"S0066":1,"S0016":1,"S0393":1,"S0278":1,"S0260":1,"S0026":1,"S0150":1,"S0054":1,"S0390":1,"S0256":1,"S0130":1,"S0093":1,"S0169":1,"S0034":1,"S0340":1,"S0058":1,"S0046":1,"S0331":1,"S0321":1,"S0180":1,"S0384":1,"S0375":1,"S0242":1,"S0109":1,"S0043":1,"S0422":1,"S0382":1,"S0323":1,"S0304":1,"S0135":1,"S0068":1,"S0063":1,"S0354":1,"S0116":1,"S0383":1,"S0276":1,"S0229":1,"S0124":1,"S0059":1,"S0407":1,"S0380":1,"S0015":1,"S0343":1,"S0283":1,"S0250":1,"S0125":1,"S0392":1,"S0265":1,"S0082":1,"S0036":1,"S0024":1,"S0395":1,"S0369":1,"S0335":1,"S0266":1,"S0122":1,"S0023":1,"S0403":1,"S0300":1,"S0172":1,"S0153":1,"S0221":1,"S0443":1,"S0358":1,"S0348":1,"S0103":1,"S0067":1,"S0365":1,"S0213":1,"S0031":1,"S0359":1,"S0309":1,"S0259":1,"S0041":1};
plot_hist(data, sort_map, "depth");
plot_bc(data, bc_full, sort_map);
</script>
{% endblock %}
