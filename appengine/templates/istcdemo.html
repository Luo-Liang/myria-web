{% extends "demobase.html" %}

<!--{% block queries_active %} class="active"{% endblock %}-->

{% block extra_head %}
<link rel="stylesheet" type="text/css" href="css/queryvis.css">
<link rel="stylesheet" type="text/css" href="css/istcdemo.css">
{% endblock %}

{% block extra_container_class %}my-fluid-container{% endblock %}

{% block content %}

{% endblock %}
{% block extra_body %}
<div id="vis-tooltip" class="vg-tooltip"></div>
<div style="margin:4px; padding:4px">
<table>
    <h2>Screen 3: Genomic Data Processing</h2>
    <tr>
        <h4>MetaData Visualizer:</h4>
        Add a filter: <input id="filter_text" type="text" value="depth<30"> <button id="filter" onclick="filter()">Update</button>
        <td>
            <div style="margin:4px; padding:4px">
                <p>x-axis: <select id="x_select" onchange="update()"> </select></p>
            </div>
        </td>
        <td>
            <div style="margin:4px; padding:4px">
                <p>x-axis: <select id="x_select2" onchange="update2()"> </select></p>
            </div>
        </td>
        <td>
            <div style="margin:4px; padding:4px">
                <h4>Time series:</h4>
            </div>
        </td>
    </tr>
    <tr>
        <td>
            <div style="margin:4px; padding:4px">
                <p>y-axis: <select id="y_select" onchange="update()"> </select></p>
            </div>
        </td>
        <td>
            <div style="margin:4px; padding:4px">
                <p>y-axis: <select id="y_select2" onchange="update2()"> </select></p>
            </div>
        </td>
        <td>
            <div style="margin:4px; padding:4px">
                <p>y-axis: <select id="time_select" onchange="update_time()"> </select></p>
            </div>
        <td>
    </tr>
    <tr>
        <td>
            <div style="margin:4px; padding:4px">
                <div id="plot"></div>
            </div>
        </td>
        <td>
            <div style="margin:4px; padding:4px">
                <div id="plot2"></div>
            </div>
        </td>
        <td>
            <div style="margin:4px; padding:4px">
                <div id="time_series"></div>
            </div>
        </td>
    </tr>
</table>
<table>
    <tr>
        <td>
            <div style="margin:4px; padding:4px">
                Aggregate Entropy Skew for x-axis: <input id="agg_text" type="text" value="<10"> <button id="aggcon" onclick="aggregate()">Fetch aggregate</button> <p id="query_status"></p>
            </div>
        </td>
    </tr>
</table>
</div>

<div id="bcdiv" style="margin:4px; padding:4px">
    <h4>Dissimilarity between samples: </h4>
    <table>
        <tr>
            <td>
                Darker colors imply more distance
            </td>
            <td>
                Choose another variable: <select id="var_select" onchange="update_hist()"> </select> <button id="sort_fields" onclick="sort_everything()">Sort</button>
            </td>
        </tr>
    <tr>
        <td><div id="diversity"></div></td>
        <td>
            <div id="plot_hist"></div>
        </td>
    </tr>
    </table>
</div>


{% endblock %}
{% block footer %}
<script src="js/d3.min.js" type="text/javascript" charset="utf-8"></script>
<script src="js/colorbrewer.js" type="text/javascript" charset="utf-8"></script>
<script src="js/d3.selection.popover.js" type="text/javascript" charset="utf-8"></script>
<script src="js/d3.selection.tooltip.js" type="text/javascript" charset="utf-8"></script>
<script src="js/chroma.min.js" type="text/javascript" charset="utf-8"></script>
<script src="js/graph.js" type="text/javascript" charset="utf-8"></script>
<script src="js/networkvis.js" type="text/javascript" charset="utf-8"></script>
<script src="js/fragmentvis.js" type="text/javascript" charset="utf-8"></script>
<script src="js/fragmentoverview.js" type="text/javascript" charset="utf-8"></script>
<script src="js/operatorvis.js" type="text/javascript" charset="utf-8"></script>
<script src="js/querystats.js" type="text/javascript" charset="utf-8"></script>
<script src="js/colorlegend.js" type="text/javascript" charset="utf-8"></script>
<script src="js/viz.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="js/queryvis.js" charset="utf-8"></script>
<script>
function plot(data, xattr, yattr, divname, extra_result) {
    function applyfilter(row){
        var filter_text = document.getElementById('filter_text').value;
        keys = Object.keys(data[0]);
        for (k in keys)
            filter_text = filter_text.replace(keys[k], "row[\'"+ keys[k] +"\']");
        if (filter_text == '')
            return 1==1;
        else
            return eval(filter_text);
    }

    data = data.filter(applyfilter);

    if (extra_result !== undefined){
        for (r in data)
            data[r]['color'] = 'Sample';
        newp = {};
        newp['color'] = 'Aggregate';
        newp[xattr] = extra_result['average'];
        newp['entropy'] = extra_result['entropy'];
        data.push(newp);
        console.log(data[data.length -1]);
    }

    var vlSpec = {
        "data": {
            "values": data
        },
        "mark": "circle",
        "encoding": {
            "x": {
                "field": xattr,
                "type": "quantitative",
                "scale":{
                    "zero":false
                }
            },
            "y": {
                "field": yattr,
                "type": "quantitative",
                "scale":{
                    "zero":false
                }
            }
        }
    };

    if (extra_result !== undefined){
        vlSpec['encoding']['color'] = {"field": "color", "type": "nominal"};
    }

    var embedSpec = {
        mode: "vega-lite",
        spec: vlSpec
    };
    var options = {
      showAllFields: false,
      fields: [
        {
          field: xattr
        },
        {
          field: yattr
        },
        {
          field: "sampleid",
          title: "Sample"
        }],
      colorTheme: "dark"
    };
    vg.embed(divname, embedSpec, function(error, result) {
        vl.tooltip(result.view, vlSpec, options);
    });
};

function plot_timeseries(data, yattr) {
    for(var i=0; i<data.length; i++){
        data[i]["jsdate"] = Math.floor(new Date(data[i]["Date"]).getTime()/8.64e7) - 14610;
        //8.64e7 is the number of milliseconds in a day
    }

    function applyfilter(row){
        var filter_text = document.getElementById('filter_text').value;
        keys = Object.keys(data[0]);
        for (k in keys)
            filter_text = filter_text.replace(keys[k], "row[\'"+ keys[k] +"\']");
        if (filter_text == '')
            return 1==1;
        else
            return eval(filter_text);
    }

    data = data.filter(applyfilter);

    var vlSpec = {
        "data": {
            "values": data
        },
        "mark": "circle",
        "encoding": {
            "x": {
                "field": "jsdate",
                "type": "quantitative",
                "axis": {"title": "Number of days since 1-1-2010."}
            },
            "y": {
                "field": yattr,
                "type": "quantitative",
                "scale":{
                    "zero":false
                }
            }
        }
    };

    var embedSpec = {
        mode: "vega-lite",
        spec: vlSpec
    };
    var options = {
      showAllFields: false,
      fields: [
        {
          field: "Date"
        },
        {
          field: yattr
        },
        {
          field: "sampleid",
          title: "Sample"
        }],
      colorTheme: "dark"
    };
    vg.embed("#time_series", embedSpec, function(error, result) {
        vl.tooltip(result.view, vlSpec, options);
    });
};

function plot_hist(data, sort_map, yattr) {
    document.getElementById('var_select').value = yattr;
    for(var i = 0; i< data.length; i++){
        data[i]["sortindex"] = data.length - sort_map[data[i]["Library"]] + 1;
    }

    function applyfilter(row){
        var filter_text = document.getElementById('filter_text').value;
        keys = Object.keys(data[0]);
        for (k in keys)
            filter_text = filter_text.replace(keys[k], "row[\'"+ keys[k] +"\']");
        if (filter_text == '')
            return 1==1;
        else
            return eval(filter_text);
    }

    data = data.filter(applyfilter);

    var vlSpec = {
        "data": {
            "values": data
        },
        "mark": "circle",
        "encoding": {
            "y": {
                "field": "Library",
                "type": "ordinal",
                "axis": false,
                "sort": {"op":"mean", "field": "sortindex"}
            },
            "x": {
                "field": yattr,
                "type": "quantitative",
                "axis": {
                    "orient":"top",
                    "offset":18
                },
                "scale":{
                    "zero":false
                }
            }
        },
        "config": {
        "scale": {
            "textBandWidth": 15,
            "bandSize": 15
        }
    }
    };

    var embedSpec = {
        mode: "vega-lite",
        spec: vlSpec
    };
    var options = {
      showAllFields: false,
      fields: [
        {
          field: "sampleid",
          title: "Sample"
        },
        {
          field: yattr
        }],
      colorTheme: "dark"
    };
    vg.embed("#plot_hist", embedSpec, function(error, result) {
        vl.tooltip(result.view, vlSpec, options);
    });
};

function plot_bc(data, bc_full, sort_map, filter){
    for(var i = 0; i< bc_full.length; i++){
        bc_full[i]["sortindexa"] = bc_full.length - sort_map[bc_full[i]["a"]] +1;
        bc_full[i]["sortindexb"] = sort_map[bc_full[i]["b"]];
    }

    function applyfilter(row){
        var filter_text = document.getElementById('filter_text').value;
        keys = Object.keys(data[0]);
        for (k in keys)
            filter_text = filter_text.replace(keys[k], "row[\'"+ keys[k] +"\']");
        if (filter_text == '')
            return 1==1;
        else
            return eval(filter_text);
    }

    data = data.filter(applyfilter);
    filtered_samples = [];
    for(d in data)
        filtered_samples.push(data[d]['Library']);
    bc_filtered = [];
    for(d in bc_full)
        if (filtered_samples.indexOf(bc_full[d]['a']) != -1 && filtered_samples.indexOf(bc_full[d]['b']) !=-1)
            bc_filtered.push(bc_full[d]);

    var vlSpec_bc = {
        "data": {
            "values": bc_filtered
        },
        "mark": "text",
        "encoding": {
            "row": {
                "field": "a",
                "type": "nominal",
                "axis": {
                    "orient":"right",
                    "title":"Sample"
                },
                "sort": {"op":"mean", "field": "sortindexa"}
            },
            "column": {
                "field": "b",
                "type": "nominal",
                "axis": {
                    "labelAngle": -90,
                    "offset": 20,
                    "title": "Sample"
                },
                "sort": {"op":"mean", "field": "sortindexb"}
            },
            "color": {
                "field": "d",
                "type": "quantitative",
                "legend":{"orient":"left", "title": "Bray-Curtis dissimilarity"}
            },
            "text": {
                "field": "none",
                "type": "nominal"
            }
        },
        "config": {
            "mark": {
                "applyColorToBackground": true
            },
            "scale": {
                "textBandWidth": 15,
                "bandSize": 15
            }
        }
    };
    var embedSpec_bc = {
        mode: "vega-lite",
        spec: vlSpec_bc
    };
    var options = {
      showAllFields: false,
      fields: [
        {
          field: "a",
          title: "Sample a"
        },
        {
          field: "b",
          title: "Sample b"
        },
        {
          field: "d",
          title: "Bray-Curtis dissimilarity"
        }],
      colorTheme: "dark"
    };
    vg.embed("#diversity", embedSpec_bc, function(error, result) {
        vl.tooltip(result.view, vlSpec_bc, options);
    });
}

function _update(x,y,d) {
    plot({{ data | safe }}, document.getElementById(x).value, document.getElementById(y).value, d);
}

function update(){
    _update('x_select','y_select','#plot');
}

function update2(){
    _update('x_select2','y_select2','#plot2');
}

function update_time(){
    plot_timeseries(data, document.getElementById('time_select').value);
}

function update_hist(){
    if (default_sorting == false)
        plot_bc(data, bc_full, sort_map);
        default_sorting = true;
    plot_hist(data, sort_map, document.getElementById('var_select').value);
}

function sort_everything(){
    var data = {{ data | safe }};
    var bc_full = {{ bc_full | safe }};

    var sort_field = document.getElementById('var_select').value;
    var sorted_data = [];
    for(var i=0; i<data.length; i++){
        sorted_data.push({"sample":data[i]["Library"], "sort_field": data[i][sort_field]});
    }

    function compare(a,b) {
        if (a['sort_field'] < b['sort_field'])
            return -1;
        if (a['sort_field'] > b['sort_field'])
            return 1;
        return 0;
    }
    sorted_data.sort(compare);

    var sort_map = {};
    for(var i=0; i<sorted_data.length; i++)
        sort_map[sorted_data[i]["sample"]] = i+1;
    plot_bc(data, bc_full, sort_map);
    plot_hist(data, sort_map, sort_field);
    default_sorting = false;
}

function filter(){
    d = init();
    data = d[0];
    bc_full = d[1];
    sort_map = d[2];
    default_sorting = true;
    plot_hist(data, sort_map, document.getElementById('var_select').value);
    plot_bc(data, bc_full, sort_map);
    update();
    update2();
    update_time();
}

function aggregate(){
    d = init();
    data = d[0];
    sort_map = d[2];
    default_sorting = true;
    agg_samples_over = document.getElementById('agg_text').value;
    x_field = document.getElementById('x_select2').value;
    q = "sample_data = scan(SampleToEnvironmental_All); kmercnts = scan(kmercnt_11_forward_Pkmer);filtered = select sum(k.cnt) as cnt, k.kmer from sample_data s, kmercnts k where k.sampleid = s.sampleid and " + x_field + agg_samples_over + ";filtered_sum = select sum(cnt) as sum_cnt from filtered;filtered_norm = select k.kmer, k.cnt/s.sum_cnt as norm_cnt from filtered k, filtered_sum s;entropy = select 22 + sum(norm_cnt*log(norm_cnt)/log(2)) as entropy from filtered_norm; avg_depth = select avg(depth) as average from sample_data where " + x_field + agg_samples_over + "; ent_depth = select entropy, average from avg_depth,entropy; store(ent_depth, agg_ent);";
    console.log(q);
    function wait_for_completion(qid){
        $.getJSON('/execute', {'queryId':  qid}, function(result) {
                if (result.status == 'RUNNING'){
                    console.log('running');
                    document.getElementById('query_status').innerHTML += '...'
                    setTimeout(function () {wait_for_completion(qid);},10000);
                }
                else{
                    document.getElementById('query_status').innerHTML = 'Finished.'
                    url = "http://"+ {{ hostname | safe }} + ":" + {{ port | safe}} + "/dataset/user-public/program-adhoc/relation-agg_ent/data";
                    $.getJSON(url, {'format': 'json'}, function(d){
                        console.log(d);
                        document.getElementById('x_select2').value = "depth";
                        document.getElementById('y_select2').value = "entropy";
                        plot(data, "depth", "entropy", "#plot2", d[0]);
                    });
                }
        });
    };
    $.post( "/execute", { query: q, language: "myrial", profile: false, push_sql: false, multiway_join: false}, function( d ) {
        document.getElementById('query_status').innerHTML = 'Running...'
        wait_for_completion(d['queryId']);
    });
}


// Initialization
function init(){
    var data = {{ data | safe }};
    var bc_full = {{ bc_full | safe }};
    var sort_map = {};
    for(var i=0; i<data.length; i++)
        sort_map[data[i]["sampleid"]] = data[i]["clusterid"];
    return [data, bc_full, sort_map];
}

d = init();
data = d[0];
bc_full = d[1];
sort_map = d[2];

var select_dds = ["x_select", "y_select", "var_select", "x_select2", "y_select2", "time_select"];

for (dd in select_dds) {
    var s = document.getElementById(select_dds[dd]);
    keys = Object.keys(data[0]);
    keys.sort();
    for (k in keys) {
        if (typeof(data[0][keys[k]]) != "string"){
            var o = document.createElement("option");
            o.value = keys[k];
            o.text = keys[k];
            s.appendChild(o);
        }
    }
}

var default_sorting = true;

document.getElementById('x_select').value = "depth";
document.getElementById('y_select').value = "simp";
plot(data, "depth", "simp", "#plot");

document.getElementById('x_select2').value = "depth";
document.getElementById('y_select2').value = "entropy";
plot(data, "depth", "entropy", "#plot2");
document.getElementById('time_select').value = "simp";
plot_timeseries(data, "simp");
plot_hist(data, sort_map, "entropy");
plot_bc(data, bc_full, sort_map);
</script>
{% endblock %}
